---
title: "Take Home Ex3: VAST Challenge 2024 Mini-Challenge 3 [WIP]"
author: "Kristine Joy Paas"
date: "22 May 2024"
date-modified: "last-modified"
format: html
execute: 
  echo: true
  eval: true
  warning: false
  freeze: true
---

# 1 Overview

-   MC3 intro

-   Analyze power flow

# 2 Setup

## 2.1 Loading Packages

```{r}
#| label: setup
pacman::p_load(
  jsonlite,
  tidyverse,
  ggraph,
  tidygraph,
  visNetwork,
  patchwork,
  ggtext,
  knitr,
  igraph,
  ggiraph
)
```

We will also set some values to have consistency throughout all graphs. This is also so that we don't have to search and replace all instances of these

```{r}
FONT_FAMILY = "Roboto Condensed"
PRIMARY_COLOR = "blue"
MUTED_COLOR = "grey50"
DEFAULT_SEED = 911 # For reproduceability
```

## 2.2 Loading Data

```{r}
mc3_data <- fromJSON("data/mc3.json")
glimpse(mc3_data)
```

It contains graph data, where nodes can be accessed via `nodes` and edges via `links`. This dataset has a lot of columns but we will only filter the relevant data during wrangling..

# 3 Data Wrangling

## 3.1 Extracting Graph Elements

For simplicity, we will only extract the columns that are needed to do graph analysis. We will also *ignore* the time elements for now so we will not be including them in the analysis.

::: panel-tabset
### Nodes

The nodes represent the entities in the network. They can be people or companies.

```{r}
mc3_nodes_raw <- as_tibble(mc3_data$nodes)
glimpse(mc3_nodes_raw)
```

We will only retain the following columns:

-   `id` - to serve as the identifier for the node

-   `type` - to differentiate people from companies in the graph.

```{r}
mc3_nodes_lite <- mc3_nodes_raw %>% select(id, type)
```

### Edges

The edges represent the relationship between different nodes.

```{r}
mc3_edges_raw <- as_tibble(mc3_data$links)
glimpse(mc3_edges_raw)
```

We will only retain the following columns:

-   `source` - to identify the *actor* of the relationship, corresponds to `id` in nodes.

-   `target` - to identify the *receiver* of the relationship, corresponds to `id` in nodes.

-   `type` - to identify the type of the relationship

```{r}
mc3_edges_lite <- mc3_edges_raw %>% select(source, target, type)
```
:::

## 3.2 Closer look at *type*

Both the `nodes` and `edges` have `type` which contains the type of the nodes and edges. We will assign a `supertype` and a `subtype` from `type`.

::: panel-tabset
### Nodes

```{r}
(mc3_nodes_lite$type) %>% unique()
```

`supertype` - type of entity, either *Person* or *Organization*

`subtype` - subcategory of *supertype*, e.g., *Company, FishingCompany, CEO*

### Edges

```{r}
(mc3_edges_lite$type) %>% unique()
```

`supertype` - type of relationship, either *Ownership*, *Employment, Relationship.*

`subtype` - subcategory of *supertype*, e.g., *Shareholdership, BeneficialOwnership, FamilyRelationship*
:::

## 3.3 Preparing the data

With the considerations above, we will shape the data needed for our graph visualization.

::: panel-tabset
### Nodes

For nodes, we will also assign a shape for visualization depending on *supertype.* For people, we will use üìê, while we use üî¥ for organizations.

Lastly, we will assign alias to each node as an alternative label to the names (as they are long). This will be generated using initials of the name.

```{r}
#| file: helpers/to_initials.R
```

```{r, include = FALSE}
#| echo: false
to_initials <- source("helpers/to_initials.R", local = knitr::knit_global())$value
```

```{r}
mc3_nodes_clean <- mc3_nodes_lite %>%
  mutate(
    name = id,
    alias = sapply(name, to_initials),
    supertype = strsplit(type, ".", fixed=TRUE) %>% sapply('[', 2),
    # Get the last type as subtype. In the case of Entity.Person,
    # both supertype and subtype are "Person".
    subtype = strsplit(type, ".", fixed=TRUE) %>% sapply(tail, n=1)
    # Names are long so will create alias from initials of name for display in graph
  ) %>%
  select(name, alias, supertype, subtype)

kable(head(mc3_nodes_clean))
```

Let's also check if `supertype`, `subtype`, have been mapped correctly.

```{r}
mc3_nodes_clean %>%
  group_by(supertype, subtype) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  kable()
```

### Edges

For `ggraph` to plot the edges correctly, we need to assigns weights to the edges. For simplicity, let us assign the number of edges with the same `source`, `target` and `type`.

Lastly, we will change `source` and `target` to `from` and `to`, respectively for compatibility with network functions we will use.

```{r}
mc3_edges_clean <- mc3_edges_lite %>%
  rename(from = source, to = target, ) %>%
  mutate(
    supertype = ifelse(
      grepl("Event.Owns", type),
      "Ownership",
      ifelse(grepl("Relationship", type), "Relationship", "Employment")
    ),
    subtype = strsplit(type, ".", fixed = TRUE) %>% sapply(tail, n = 1)
  ) %>%
  filter(from != to) %>%
  group_by(from, to, supertype, subtype) %>%
  summarize(weight = n())

kable(head(mc3_edges_clean))
```

Lastly, let's check if `type` has been mapped correctly to `supertype` and `subtype`.

```{r}
mc3_edges_clean %>%
  group_by(supertype, subtype) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  kable()
```
:::

## 3.4 Preparing the supernetwork

We will prepare the supernetwork from the nodes and edges we prepared.

```{r}
supernetwork = tbl_graph(edges = mc3_edges_clean,
                         nodes = mc3_nodes_clean,
                         directed = TRUE)
```

We call this a supernetwork as this covers the entire network of entities within the fishing business community.

```{r}
#| echo: false
# Clean up environment
rm(mc3_data)
rm(mc3_nodes_raw, mc3_nodes_lite, mc3_nodes_clean)
rm(mc3_edges_raw, mc3_edges_lite, mc3_edges_clean)
rm(to_initials)
```

# 4 Extracting subnetworks

## 4.1 Extracting for ease of analysis

As the `supernetwork` is very large, we will need to extract part of it to perform analysis effectively. To do this, we will need to extract subnetworks from this bigger network.

::: panel-tabset
### Explanation

We will extract subnetworks based on distance from a given node. By default, we will get the network of all **connected nodes** to the reference node.

We will use the following functions:

-   `ego()` from *igraph* to get a list of nodes within a given distance from the given node

-   `induced_subgraph()` to extract the subgraph containing only the nodes from the result of `ego()`. This will return an *igraph* type.

-   `as_data_frame()` to extract the nodes and edges so we can generate a `tbl_graph` which is compatible to both *igraph* and *ggraph* functions.

### Function

```{r}
#| file: helpers/extract_subnetwork.R
```

```{r, include = FALSE}
#| echo: false
extract_subnetwork <- source("helpers/extract_subnetwork.R", local = knitr::knit_global())$value
```
:::

## 4.2 Plotting the subnetworks

To demonstrate what this function does, we will look at 3 subnetworks related to *SouthSeafood Express Corp.*

1.  Direct neighbors - They have the strongest influence on and can be influenced the most by *SouthSeafood Express Corp.*
2.  Sphere of influence - Based on Nicholas A. Christakis and James H. Fowler's theory of [**Three Degrees of Influence**](https://www.strategy-business.com/article/10218), which states that that influence gradually dissipates and eventually cease to be notable beyond the **3rd degree of separation**. This contains the nodes where *SouthSeafood Express Corp have* notable influence.
3.  Connected network - We will look at the entire network containing the nodes that are connected to *SouthSeafood Express Corp* in any way.

We will use `plot_fishing_relationships()` to plot the relationship graph of the network.

```{r}
#| code-fold: true
#| code-summary: 'Show the code for plot_fishing_relationships()'
#| file: helpers/plot_fishing_relationships.R
```

```{r, include = FALSE}
#| echo: false
plot_fishing_relationships <- source("helpers/plot_fishing_relationships.R", local = knitr::knit_global())$value
```

::: {.callout-tip collapse="true" appearance="simple"}
### Relationship Graph

We call this the *Relationship Graph* as the provided graph shows the different relationships among the different entities.

Later, we will tackle how to generate the *Power Graph* which will represent the power and flow of resources within the network.
:::

::: panel-tabset
### Direct Neighbors

```{r}
#| code-fold: true
#| code-summary: 'Show the code'
extract_subnetwork(
  supernetwork,
  node_name="SouthSeafood Express Corp",
  distance=1
) %>% plot_fishing_relationships(
  layout = "linear",
  circular = TRUE,
  node_size = 12,
  arrow_margin = 5.5,
  title = "SouthSeafood Express Corp's Direct Neighbors",
  subtitle = "Two other fishing companies, <span style='color:blue;'>**AguaLeska Transit N.V.**</span> and <span style='color:blue;'>**Tainamarine Fishing Co**</span> hold shares in<br />SouthSeafood Express Corp. They are posed to benefit the most from the company's illegal fishing activities."
)
```

::: callout-tip
#### Insights

As shareholders, **AguaLeska Transit N.V.** and **Tainamarine Fishing Co** have big influence on where the resources of *SouthSeafood Express Corp* go.

In this case, most of it will most likely opposite of the arrow direction, i.e. benefitting the shareholders.
:::

### Sphere of Influence

```{r}
#| code-fold: true
#| code-summary: 'Show the code'
extract_subnetwork(
  supernetwork,
  node_name="SouthSeafood Express Corp",
  distance=3
) %>% plot_fishing_relationships(
  title = "SouthSeafood Express Corp's Sphere of Influence",
  subtitle = "Entities with 3 degrees of separation from **SouthSeafood Express Corp**. This is where the influence of the<br />company is noticeable."
)
```

::: callout-tip
#### Insights

The network map is comprised mostly of *Shareholderships* and *BenificialOwnerships.*

*SouthSeafood Express Corp's* shareholders, **AguaLeska Transit N.V.** and **Tainamarine Fishing Co** have additional shareholders.

**StichtingMarine Shipping Company** holds shares in these companies (via other entities). **SavanetaCreek Solutions N.V.**, a Logistics Company, also holds a shareholdership in StichtingMarine Shipping Company. These two nodes serve as resource hubs, gathering resources from the companies in which they hold shares, ultimately benefiting their owners and shareholders.

Moreover, **Liam Conti** and **Fintan Park** are the beneficial owners of these companies, giving them final decision-making power and likely the greatest benefits from the network's resources. Additionally, as a family member of **Liam Conti**, **Nadia Conti** may also benefit from Liam's ownership of these companies.

Intuitively, these five nodes are likely candidates for the most influential entities within the network.
:::

### Connected Network

```{r}
#| code-fold: true
#| code-summary: 'Show the code'
extract_subnetwork(
  supernetwork,
  node_name="SouthSeafood Express Corp"
) %>% plot_fishing_relationships(
  node_size = 5,
  arrow_margin = 2,
  title = "SouthSeafood Express Corp's Full Network",
  subtitle = "This shows the full view of the network connected to SouthSeafood Express Corp in any way."
)
```

::: callout-tip
#### Insights

With this sheer number of nodes, it is hard to infer any relationships aside from general estimate of how many of each entity and the type of relationships present in the system.

We should consider using other tools that provide more interactivity, like `visNetwork`.

Later on, we will explore different centralities to help infer which entities are most influential in the network.
:::
:::

# 5 Generating Power Graph

To figure out who are the most influential or greatest beneficiaries within the network, we have to look at the power dynamics in each relationship.

## 5.1 Direction

As we want to investigate the flow of power and resources, the direction will be from the **less powerful to more powerful** entity.

## 5.2 Weights

For the purpose of our analysis, we will score each relationship flow according to the following:

-   Benefits from the resources: 1 (+1 if they are the owner of a company)

-   A decision-maker on where resources go: 2 (+1 if they are the ultimate decision maker)

-   Influential on the other person: 1 (only if target is a person)

We will use the total as the weights for each edge. Lastly, we will rename the relationship to prevent confusion in case of direction reversal.

## 5.3 Score table

+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
|                         | BeneficialOwner                                                                                                          | Shareholdership                                                                                                                               | WorksFor                                                                         | FamilyRelationship                                                                                        |
+=========================+==========================================================================================================================+===============================================================================================================================================+==================================================================================+===========================================================================================================+
| Current **From**        | Owner                                                                                                                    | Shareholder                                                                                                                                   | Employee                                                                         | Person 1                                                                                                  |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| Current **To**          | Company                                                                                                                  | Company                                                                                                                                       | Employer                                                                         | Person 2                                                                                                  |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| New **From\             | Company                                                                                                                  | Company                                                                                                                                       | Employee                                                                         | Person 2 (additional)                                                                                     |
| **(Lower power)         |                                                                                                                          |                                                                                                                                               |                                                                                  |                                                                                                           |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| New **To\               | Owner                                                                                                                    | Shareholder                                                                                                                                   | Employer                                                                         | Person 2                                                                                                  |
| **(Higher power)        |                                                                                                                          |                                                                                                                                               |                                                                                  |                                                                                                           |
|                         |                                                                                                                          |                                                                                                                                               |                                                                                  | (additional)                                                                                              |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| New **subtype**         | OwnedBy                                                                                                                  | HasShareholder                                                                                                                                | WorksFor                                                                         | FamilyRelationship                                                                                        |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| Beneficiary             | 1 + 1                                                                                                                    | 1                                                                                                                                             | 0                                                                                | 1                                                                                                         |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| Decision-maker          | 2 + 1                                                                                                                    | 2                                                                                                                                             | 1                                                                                | 0                                                                                                         |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| Influential (on person) | 0                                                                                                                        | 0                                                                                                                                             | 1                                                                                | 1                                                                                                         |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| **Total**               | **5**                                                                                                                    | **3**                                                                                                                                         | **2**                                                                            | **2**                                                                                                     |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+
| Rationale               | Beneficial owners benefit from the resources of the company.                                                             | Shareholders may receive proceeds from the profits of the company.                                                                            | Employees are contractually obligated to act in the interests of their employer. | Assuming that family members have a healthy relationship, they share resources and confide in each other. |
|                         |                                                                                                                          |                                                                                                                                               |                                                                                  |                                                                                                           |
|                         | While BeneficialOwners may or may not be Shareholders in the same company, they hold the ultimate decision-making power. | They have some decision-making power within the company. However, it is the Beneficial Owner that ultimately gets the final say in decisions. | Employers also decide what their employees do.                                   | Due to this, they have power over each other.                                                             |
+-------------------------+--------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------+

::: {.callout-important appearance="simple"}
These scores are subjective and based on general assumptions. We also lack the information to model the power dynamics accurately.
:::

## 5.4 Converting relationship edges to power flow

Using the table above, we will create a function to convert relationship edges to power flow.

```{r}
#| file: helpers/convert_edges_to_power_flow.R
```

```{r, include = FALSE}
#| echo: false
convert_edges_to_power_flow <- source("helpers/convert_edges_to_power_flow.R", local = knitr::knit_global())$value
```

Let us check the resulting edges table. We are expecting that all edge types would have the same number, expect for *FamilyRelationship*, which is expected to **double**.

::: panel-tabset
### Relationship

```{r}
supernetwork %>%
  activate(edges) %>% as.data.frame() %>%
  group_by(supertype, subtype) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  kable()
```

### Power

```{r}
supernetwork %>%
  convert_graph_to_power_flow() %>%
  activate(edges) %>% as.data.frame() %>%
  group_by(supertype, subtype) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  kable()
```
:::

## 5.5 Converting relationship graphs to power flow

Using the edge converter, we will generate a new `tbl_graph` with the power flow edges.

```{r}
#| file: helpers/convert_graph_to_power_flow.R
```

```{r, include = FALSE}
#| echo: false
convert_graph_to_power_flow <- source("helpers/convert_graph_to_power_flow.R", local = knitr::knit_global())$value
```

## 5.6 Plotting the power graph

Similar to [4.2 Plotting the subnetworks], we will look at 3 subnetworks related to *SouthSeafood Express Corp*.

We will use `plot_fishing_power()` to plot the relationship graph of the network.

```{r}
#| code-fold: true
#| code-summary: 'Show the code for plot_fishing_power()'
#| file: helpers/plot_fishing_power.R
```

```{r, include = FALSE}
#| echo: false
plot_fishing_power <- source("helpers/plot_fishing_power.R", local = knitr::knit_global())$value
```

::: panel-tabset
### Direct Neighbors

```{r}
#| code-fold: true
#| code-summary: 'Show the code'
supernetwork %>%
  extract_subnetwork(node_name = "SouthSeafood Express Corp", distance = 1) %>%
  convert_graph_to_power_flow() %>%
  plot_fishing_power(
    title = "SouthSeafood Express Corp's Sphere of Influence",
    subtitle = "Entities with 3 degrees of separation from **SouthSeafood Express Corp**. This is where the influence of the<br />company is noticeable."
  )
```

### Sphere of Influence

```{r}
#| code-fold: true
#| code-summary: 'Show the code'
supernetwork %>%
  extract_subnetwork(node_name = "SouthSeafood Express Corp", distance = 3) %>%
  convert_graph_to_power_flow() %>%
  plot_fishing_power(
    layout = "linear",
    circular = TRUE,
    node_size = 12,
    arrow_margin = 5.5,
    title = "SouthSeafood Express Corp's Direct Neighbors",
    subtitle = "Two other fishing companies, <span style='color:blue;'>**AguaLeska Transit N.V.**</span> and <span style='color:blue;'>**Tainamarine Fishing Co**</span> hold shares in<br />SouthSeafood Express Corp. They are posed to benefit the most from the company's illegal fishing activities."
  )
```

### Connected Network
:::
